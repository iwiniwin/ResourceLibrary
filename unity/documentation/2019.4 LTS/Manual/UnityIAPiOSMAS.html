<!DOCTYPE html><html class="no-js" lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-5V25JL6');
    </script>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="twitter:card" content="summary">
<meta property="og:title" content="iOS App Store 和 Mac App Store - Unity 手册">
<title>iOS App Store 和 Mac App Store - Unity 手册</title>
<meta name="description" content="应用程序收据 (App Receipt) 存储在设备的本地存储器中，可以按如下方式读取：">
<meta property="og:description" content="应用程序收据 (App Receipt) 存储在设备的本地存储器中，可以按如下方式读取：">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="https://unity.com/themes/contrib/unity_base/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFiles/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFiles/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFiles/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFiles/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFiles/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFiles/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFiles/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFiles/images/favicons/tileicon-144x144.png">
<script type="text/javascript" src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" charset="UTF-8" data-domain-script="6e91be4c-3145-4ea2-aa64-89d716064836"></script><script type="text/javascript">
        function OptanonWrapper() { }
    </script><script>
      var docs_type = 'Manual';
      var lang = 'cn';
      var page = 'UnityIAPiOSMAS';
      if(!page) page = 'index';
      var version = '2019.4';
      var docs_versions = [{version: '2021.1',version_string: '2021.1',supported: true},{version: '2020.3',version_string: '2020.3',supported: true},{version: '2020.2',version_string: '2020.2',supported: false},{version: '2020.1',version_string: '2020.1',supported: false},{version: '2019.4',version_string: '2019.4',supported: true},{version: '2019.3',version_string: '2019.3',supported: false},{version: '2019.2',version_string: '2019.2',supported: false},{version: '2019.1',version_string: '2019.1',supported: false},{version: '2018.4',version_string: '2018.4',supported: true},{version: '2018.3',version_string: '2018.3',supported: false},{version: '2018.2',version_string: '2018.2',supported: false},{version: '2018.1',version_string: '2018.1',supported: false},{version: '2017.4',version_string: '2017.4',supported: false},{version: '2017.3',version_string: '2017.3',supported: false},{version: '2017.2',version_string: '2017.2',supported: false},{version: '2017.1',version_string: '2017.1',supported: false},{version: '5.6',version_string: '560',supported: false},];</script><script type="text/javascript" src="../StaticFiles/js/jquery.js"></script><script type="text/javascript" src="../StaticFiles/js/core.js"></script><script type="text/javascript" src="../StaticFiles/js/jquery.sidebar.min.js"></script><script type="text/javascript" src="docdata/toc.js"></script><script type="text/javascript" src=""></script><script type="text/javascript" src="../StaticFiles/js/custom.js"></script><link rel="stylesheet" type="text/css" href="../StaticFiles/css/core.css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/custom.css">
<link rel="canonical" href="https://docs.unity3d.com/cn/2019.4/Manual/UnityIAPiOSMAS.html">
<link rel="alternate" href="https://docs.unity3d.com/en/2019.4/Manual/UnityIAPiOSMAS.html" hreflang="en">
<link rel="alternate" href="https://docs.unity3d.com/cn/2019.4/Manual/UnityIAPiOSMAS.html" hreflang="zh">
<link rel="alternate" href="https://docs.unity3d.com/ja/2019.4/Manual/UnityIAPiOSMAS.html" hreflang="ja">
<link rel="alternate" href="https://docs.unity3d.com/es/2019.4/Manual/UnityIAPiOSMAS.html" hreflang="es">
<link rel="alternate" href="https://docs.unity3d.com/kr/2019.4/Manual/UnityIAPiOSMAS.html" hreflang="ko">
<link rel="alternate" href="https://docs.unity3d.com/ru/2019.4/Manual/UnityIAPiOSMAS.html" hreflang="ru">
<link rel="alternate" href="https://docs.unity3d.com/2019.4/Documentation/Manual/UnityIAPiOSMAS.html" hreflang="x-default">
</head>
<body>
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5V25JL6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div id="nav-open" for="nav-input"><span></span></div>
<div class="logo"><a href="./index.html"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="搜索手册..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul class="menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="https://unity3d.com/">
                unity3d.com
              </a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2019.4</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;">
<ul class="versions">
<li class="supported"><a class="docs_version_url_2021.1" href="/cn/2021.1/Manual/UnityIAPiOSMAS.html">2021.1</a></li>
<li class="supported"><a class="docs_version_url_2020.3" href="/cn/2020.3/Manual/UnityIAPiOSMAS.html">2020.3</a></li>
<li class=""><a class="docs_version_url_2020.2" href="/cn/2020.2/Manual/UnityIAPiOSMAS.html">2020.2</a></li>
<li class=""><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/UnityIAPiOSMAS.html">2020.1</a></li>
<li class="supported"><a class="docs_version_url_2019.4" href="/cn/2019.4/Manual/UnityIAPiOSMAS.html">2019.4</a></li>
<li class=""><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/UnityIAPiOSMAS.html">2019.3</a></li>
<li class=""><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/UnityIAPiOSMAS.html">2019.2</a></li>
<li class=""><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/UnityIAPiOSMAS.html">2019.1</a></li>
<li class="supported"><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/UnityIAPiOSMAS.html">2018.4</a></li>
<li class=""><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/UnityIAPiOSMAS.html">2018.3</a></li>
<li class=""><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/UnityIAPiOSMAS.html">2018.2</a></li>
<li class=""><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/UnityIAPiOSMAS.html">2018.1</a></li>
<li class=""><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/UnityIAPiOSMAS.html">2017.4</a></li>
<li class=""><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/UnityIAPiOSMAS.html">2017.3</a></li>
<li class=""><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/UnityIAPiOSMAS.html">2017.2</a></li>
<li class=""><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/UnityIAPiOSMAS.html">2017.1</a></li>
<li class=""><a class="docs_version_url_560" href="/cn/560/Manual/UnityIAPiOSMAS.html">5.6</a></li>
<div class="versionsWithThisPage" style="display:none;"><li><p>包含此页的版本：</p></li></div>
<div class="versionsWithoutThisPage" style="display:none;"><li><p>不含此页的版本：</p></li></div>
</ul>
<ul class="description">
<li>
<div class="supported-box"></div>受支持</li>
<li>
<div class="legacy-box"></div>旧版</li>
</ul>
</div>
</div>
<ul class="nav-menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
<div class="lang-switcher">
<div class="current toggle" data-target=".lang-list">
<div class="lbl">语言:
        <span class="b">中文</span>
</div>
<div class="arrow"></div>
</div>
<div class="lang-list" style="display:none;"><ul>
<li><a data-lang="en" href="/2019.4/Documentation/Manual/UnityIAPiOSMAS.html">English</a></li>
<li><a data-lang="cn" href="/cn/2019.4/Manual/UnityIAPiOSMAS.html">中文</a></li>
<li><a data-lang="ja" href="/ja/2019.4/Manual/UnityIAPiOSMAS.html">日本語</a></li>
<li><a data-lang="es" href="/es/2019.4/Manual/UnityIAPiOSMAS.html">Español</a></li>
<li><a data-lang="kr" href="/kr/2019.4/Manual/UnityIAPiOSMAS.html">한국어</a></li>
<li><a data-lang="ru" href="/ru/2019.4/Manual/UnityIAPiOSMAS.html">Русский</a></li>
</ul></div>
</div>
</div></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar hidden"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc">
<h2>手册</h2>
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2019.4</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;">
<ul class="versions">
<li class="supported"><a class="docs_version_url_2021.1" href="/cn/2021.1/Manual/UnityIAPiOSMAS.html">2021.1</a></li>
<li class="supported"><a class="docs_version_url_2020.3" href="/cn/2020.3/Manual/UnityIAPiOSMAS.html">2020.3</a></li>
<li class=""><a class="docs_version_url_2020.2" href="/cn/2020.2/Manual/UnityIAPiOSMAS.html">2020.2</a></li>
<li class=""><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/UnityIAPiOSMAS.html">2020.1</a></li>
<li class="supported"><a class="docs_version_url_2019.4" href="/cn/2019.4/Manual/UnityIAPiOSMAS.html">2019.4</a></li>
<li class=""><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/UnityIAPiOSMAS.html">2019.3</a></li>
<li class=""><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/UnityIAPiOSMAS.html">2019.2</a></li>
<li class=""><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/UnityIAPiOSMAS.html">2019.1</a></li>
<li class="supported"><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/UnityIAPiOSMAS.html">2018.4</a></li>
<li class=""><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/UnityIAPiOSMAS.html">2018.3</a></li>
<li class=""><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/UnityIAPiOSMAS.html">2018.2</a></li>
<li class=""><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/UnityIAPiOSMAS.html">2018.1</a></li>
<li class=""><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/UnityIAPiOSMAS.html">2017.4</a></li>
<li class=""><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/UnityIAPiOSMAS.html">2017.3</a></li>
<li class=""><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/UnityIAPiOSMAS.html">2017.2</a></li>
<li class=""><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/UnityIAPiOSMAS.html">2017.1</a></li>
<li class=""><a class="docs_version_url_560" href="/cn/560/Manual/UnityIAPiOSMAS.html">5.6</a></li>
<div class="versionsWithThisPage" style="display:none;"><li><p>包含此页的版本：</p></li></div>
<div class="versionsWithoutThisPage" style="display:none;"><li><p>不含此页的版本：</p></li></div>
</ul>
<ul class="description">
<li>
<div class="supported-box"></div>受支持</li>
<li>
<div class="legacy-box"></div>旧版</li>
</ul>
</div>
</div>
<div class="clear"></div>
</div></div></div></div></div>
<div id="content-wrap" class="content-wrap opened-sidebar"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManual.html">Unity 用户手册 (2019.4 LTS)</a></li>
<li><a href="UnityServices.html">Unity 服务</a></li>
<li><a href="UnityIAP.html">﻿Unity IAP</a></li>
<li>应用商店指南</li>
<li>iOS App Store 和 Mac App Store</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="UnityIAPCrossStoreInstallationIssues.html"></a></span><div class="tip">Android 应用内购 (IAP) 商店的跨店安装问题</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="UnityIAPUniversalWindows.html"></a></span><div class="tip">通用 Windows 平台</div>
</div>
</div></div>
<h1>iOS App Store 和 Mac App Store</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<h2>扩展功能</h2>

<h3>读取应用程序收据</h3>

<p><a href="https://developer.apple.com/library/ios/releasenotes/General/ValidateAppStoreReceipt/Chapters/ValidateRemotely.html">应用程序收据 (App Receipt)</a> 存储在设备的本地存储器中，可以按如下方式读取：</p>

<pre><code>var builder = ConfigurationBuilder.Instance(StandardPurchasingModule.Instance());
string receipt = builder.Configure&lt;IAppleConfiguration&gt;().appReceipt;
</code></pre>

<h3>检查是否有支付限制</h3>

<p>应用内购 (IAP) 可能在设备设置中受到限制，可以按以下方式检查是否存在限制：</p>

<pre><code>var builder = ConfigurationBuilder.Instance(StandardPurchasingModule.Instance());
bool canMakePayments = builder.Configure&lt;IAppleConfiguration&gt;().canMakePayments;
</code></pre>

<h3>恢复交易</h3>

<p>在 Apple 平台上，用户必须输入密码才能检索以前的交易，因此您的应用程序必须为用户提供一个按钮来输入密码。此过程中将会针对用户已拥有的任何商品调用 <code>IStoreListener</code> 的 <code>ProcessPurchase</code> 方法。</p>

<pre><code>/// &lt;summary&gt;
/// Your IStoreListener implementation of OnInitialized.
/// &lt;/summary&gt;
public void OnInitialized(IStoreController controller, IExtensionProvider extensions)
{
    extensions.GetExtension&lt;IAppleExtensions&gt; ().RestoreTransactions (result =&gt; {
        if (result) {
            // This does not mean anything was restored,
            // merely that the restoration process succeeded.
        } else {
            //Restoration failed.
        }
    });
}
</code></pre>

<h3>刷新应用程序收据</h3>

<p>Apple 提供了一种从服务器获取新应用程序收据的机制，通常在当前没有收据缓存在本地存储中时会使用此机制：<a href="https://developer.apple.com/library/ios/documentation/StoreKit/Reference/SKReceiptRefreshRequest_ClassRef/index.html#/apple_ref/occ/cl/SKReceiptRefreshRequest">SKReceiptRefreshRequest</a>。</p>

<p>请注意，这种情况下将提示用户输入密码。</p>

<p>Unity IAP 按如下形式提供此方法：</p>

<pre><code>/// &lt;summary&gt;
/// IStoreListener 对 OnInitialized 的实现。
/// &lt;/summary&gt;
public void OnInitialized(IStoreController controller, IExtensionProvider extensions)
{
    extensions.GetExtension&lt;IAppleExtensions&gt; ().RefreshAppReceipt (receipt =&gt; {
        // 如果请求成功，则调用此处理程序。
        //收据将是最新的应用程序收据。
        Console.WriteLine(receipt);
    },
    () =&gt; {
        //如果请求失败
        //（例如网络不可用或用户输入错误的密码），
        //则会调用此处理程序。
    });
}
</code></pre>

<h3>购买前先询问</h3>

<p>iOS 8 引入了一项新的家长控制功能，将其称为<a href="https://developer.apple.com/library/ios/technotes/tn2259/_index.html#/apple_ref/doc/uid/DTS40009578-CH1-UPDATE_YOUR_APP_FOR_ASK_TO_BUY">购买前先询问 (Ask to Buy)</a>。</p>

<p>属于“购买前先询问”的购买需要经过家长批准。出现此情况时，Unity IAP 会向您的应用程序发送通知，如下所示：</p>

<pre><code>/// 在 Unity IAP 完成初始化后调用此函数。
public void OnInitialized(IStoreController controller, IExtensionProvider extensions)
{
    extensions.GetExtension&lt;IAppleExtensions&gt;().RegisterPurchaseDeferredListener(product =&gt; {
        Console.WriteLine(product.definition.id);
    });
}
</code></pre>

<h4>在 Sandbox App Store 中启用 “Ask-to-Buy” 模拟</h4>

<p>以下示例类说明了如何访问 <code>IAppleExtensions</code> 以便在 Sandbox App Store 中启用 Ask-to-Buy 模拟：</p>

<pre><code>using UnityEngine;
using UnityEngine.Purchasing;

public class AppleSimulateAskToBuy : MonoBehaviour {
    public void SetSimulateAskToBuy(bool shouldSimulateAskToBuy) {
        if (Application.platform == RuntimePlatform.IPhonePlayer) {
            IAppleExtensions extensions = IAPButton.IAPButtonStoreManager.Instance.ExtensionProvider.GetExtension&lt;IAppleExtensions&gt;();
            extensions.simulateAskToBuy = shouldSimulateAskToBuy;
        }
    }
}
</code></pre>

<p>购买被批准或拒绝时，将调用应用商店的正常 <code>ProcessPurchase</code> 或 <code>OnPurchaseFailed</code> 监听器方法。</p>

<h3>交易收据</h3>

<p>有时，属于“购买前先询问”的消耗品购买不会显示在应用程序收据中。在此情况下，无法使用该收据来验证这些购买。但是，iOS 提供包含所有购买（包括购买前先询问的购买情况）的交易收据。应使用 <code>IAppleExtensions</code> 来访问给定 <code>Product</code> 的最近交易收据字符串。</p>

<p><strong>注意</strong>：交易收据不适用于 Mac 版本。请求 Mac 版本上的交易收据时，会产生空字符串。</p>

<pre><code># if UNITY_PURCHASING

using System;
using UnityEngine;
using UnityEngine.Purchasing;

public class AskToBuy : MonoBehaviour, IStoreListener
{
    // Unity IAP 对象
    private IStoreController m_Controller;
    private IAppleExtensions m_AppleExtensions;

    public AskToBuy ()
    {
        var builder = ConfigurationBuilder.Instance (StandardPurchasingModule.Instance ());
        builder.AddProduct ("100_gold_coins", ProductType.Consumable, new IDs {
            { "100_gold_coins_google", GooglePlay.Name },
            { "100_gold_coins_mac", MacAppStore.Name }
        });

        UnityPurchasing.Initialize (this, builder);
    }

    /// &amp;lt;summary&gt;
    /// 在 Unity IAP 完成初始化时将调用此函数。
    /// &amp;lt;/summary&gt;
    public void OnInitialized (IStoreController controller, IExtensionProvider extensions)
    {
        m_Controller = controller;
        m_AppleExtensions = extensions.GetExtension&lt;IAppleExtensions&gt; ();

        // 在 Apple 平台上，我们需要处理由 Apple 的"购买前先询问"功能导致的延期购买。
        //在非 Apple 平台上，这将不起作用；永远不会调用 OnDeferred。
        m_AppleExtensions.RegisterPurchaseDeferredListener (OnDeferred);
    }

    /// &amp;lt;summary&gt;
    /// 在购买完成时将调用此函数。
    /// &amp;lt;/summary&gt;
    public PurchaseProcessingResult ProcessPurchase (PurchaseEventArgs e)
    {
        if (Application.platform == RuntimePlatform.IPhonePlayer ||
            Application.platform == RuntimePlatform.tvOS) {
            string transactionReceipt = m_AppleExtensions.GetTransactionReceiptForProduct (e.purchasedProduct);
            Console.WriteLine (transactionReceipt);
            // 将交易收据发送到服务器进行验证
        }
        return PurchaseProcessingResult.Complete;
    }

    /// &amp;lt;summary&gt;
    /// Unity IAP 遇到不可恢复的初始化错误时调用。
    ///
    /// 请注意，如果互联网不可用，则不会调用此项；
    /// Unity IAP 将尝试初始化，直到互联网变为可用为止。
    /// &amp;lt;/summary&gt;
    public void OnInitializeFailed (InitializationFailureReason error)
    {
    }

    /// &amp;lt;summary&gt;
    /// 购买失败时调用。
    /// &amp;lt;/summary&gt;
    public void OnPurchaseFailed (Product i, PurchaseFailureReason p)
    {
    }

    /// &amp;lt;summary&gt;
    /// 特定于 iOS。
    /// 未成年人要求购买并提交给家长批准时，
    /// 此函数将作为 Apple 的"购买前先询问"功能的一部分
    /// 接受调用。
    ///
    /// 购买被批准或拒绝时，将触发正常的购买
    /// 事件。
    /// &amp;lt;/summary&gt;
    /// &amp;lt;param name="item"&gt;Item.&amp;lt;/param&gt;
    private void OnDeferred (Product item)
    {
        Debug.Log ("Purchase deferred: " + item.definition.id);
    }
}

# endif // UNITY_PURCHASING
</code></pre>

<p>与应用程序收据不同，您无法在本地验证交易收据。而是必须将收据字符串发送到远程服务器进行验证。如果已使用远程服务器来验证应用程序收据，请将交易收据发送至同一 Apple 端点以接收 JSON 响应。</p>

<p>JSON 响应示例：</p>

<pre><code>{
    "receipt": {
        "original_purchase_date_pst": "2017-11-15 15:25:20 America/Los_Angeles",
        "purchase_date_ms": "1510788320209",
        "unique_identifier": "0ea7808637555b2c633eb07aa1cb0894c821a6f9",
        "original_transaction_id": "1000000352597239",
        "bvrs": "0",
        "transaction_id": "1000000352597239",
        "quantity": "1",
        "unique_vendor_identifier": "01B57C2E-9E91-42FF-9B0D-4983175D6694",
        "item_id": "1141751870",
        "original_purchase_date": "2017-11-15 23:25:20 Etc/GMT",
        "product_id": "100.gold.coins",
        "purchase_date": "2017-11-15 23:25:20 Etc/GMT",
        "is_trial_period": "false",
        "purchase_date_pst": "2017-11-15 15:25:20 America/Los_Angeles",
        "bid": "com.unity3d.unityiap.demo",
        "original_purchase_date_ms": "1510788320209"
    },
    "status": 0
}
</code></pre>

<h2>拦截 Apple 推荐性购买</h2>

<p>苹果允许你通过游戏的产品页面来促销 <a href="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/StoreKitGuide/PromotingIn-AppPurchases/PromotingIn-AppPurchases.html">游戏内购</a>。不像传统的应用内购，苹果促销性购买会直接从 iOS 和 tvOS 的 App Store 发起。随后 App Store 会启动你的应用来完成交易，或者弹窗提示用户下载应用（如果还未安装）。</p>

<p><code>IAppleConfiguration</code> <code>SetApplePromotionalPurchaseInterceptor</code> 回调方法可拦截 Apple 推荐性购买。使用此回调方法可以在向 Apple 发送购买信息之前呈现家长控制门 (parental gate)，发送分析事件，或执行其他功能。此回调会用到用户尝试购买的 <code>Product</code>。您必须调用 <code>IAppleExtensions.ContinuePromotionalPurchases()</code> 才能继续进行推荐性购买。这将启动任何排队等待的支付。</p>

<p>如果不设置回调，推荐性购买会立即通过，并调用 <code>ProcessPurchase</code> 来呈现结果。</p>

<p><strong>注意</strong>：在其他平台上调用这些 API 将不起作用。</p>

<pre><code>private IAppleExtensions m_AppleExtensions;

public void Awake() {
    var module = StandardPurchasingModule.Instance();
    var builder = ConfigurationBuilder.Instance(module);
        // 在 iOS 和 tvOS 上，我们可以拦截直接来自 App Store 的
        // 推荐性购买。
        //在其他平台上，这将不起作用；永远不会调用
        // OnPromotionalPurchase。
    builder.Configure&lt;IAppleConfiguration&gt;().
     SetApplePromotionalPurchaseInterceptorCallback(OnPromotionalPurchase);
    Debug.Log("Setting Apple promotional purchase interceptor callback");
}

public void OnInitialized(IStoreController controller, IExtensionProvider extensions) {
    m_AppleExtensions = extensions.GetExtension&lt;IAppleExtensions&gt;();
    foreach (var item in controller.products.all) {
        if (item.availableToPurchase) {
            //将所有这些商品设置为在用户的 App Store 中可见
            m_AppleExtensions.SetStorePromotionVisibility(item, AppleStorePromotionVisibility.Show);
        }
    }
}

private void OnPromotionalPurchase(Product item) {
    Debug.Log("Attempted promotional purchase: " + item.definition.id);
    // 已检测到推荐性购买。
    // 通过呈现家长控制门等方式处理此事件。
    //此处，仅出于演示目的，我们将等待五秒钟
    // 再继续购买。
    StartCoroutine(ContinuePromotionalPurchases());
}

private IEnumerator ContinuePromotionalPurchases() {
    Debug.Log("Continuing promotional purchases in 5 seconds");
    yield return new WaitForSeconds(5);
    Debug.Log("Continuing promotional purchases now");
    m_AppleExtensions.ContinuePromotionalPurchases (); // 仅限 iOS 和 tvOS
}

</code></pre>

<h2>测试</h2>

<p>要在 Apple 商店中进行测试，必须使用 iTunes Connect 测试帐户（可以在 iTunes Connect 中创建该帐户）。</p>

<p>在 iOS 设备或笔记本电脑上注销 App Store，启动您的应用程序，然后在您尝试进行购买或恢复交易时，系统会提示登录。</p>

<p>如果收到初始化失败通知而原因为 <code>NoProductsAvailable</code>，请按照以下列表逐项检查：</p>

<ul>
<li>iTunes Connect 商品标识符必须与提供给 Unity IAP 的商品标识符完全匹配</li>
<li>必须在 iTunes Connect 中为您的应用程序启用 IAP</li>
<li>商品必须已获准在 iTunes Connect 中销售</li>
<li>新建的 iTunes Connect 商品可能需要几个小时才可供购买</li>
<li>您必须同意最新的 iTunes Connect 开发者协议并提供有效的银行详细信息</li>
</ul>

<h2>Mac App Store</h2>

<p>发布到 Mac 台式机时，你必须在 Unity 的构建设置中选中 <code>Mac App Store validation</code> 。</p>

<p>编译应用程序后，必须使用 Bundle ID 和版本字符串来更新其 info.plist 文件。右键单击 <code>.app</code> 文件，然后单击 <code>show package contents</code>，找到 <code>info.plist</code> 文件，并将 <code>CFBundleIdentifier</code> 字符串更新为应用程序的 Bundle ID。</p>

<p>随后，必须对应用程序进行签名、打包和安装。您需要从 OSX 终端运行以下命令：</p>

<pre><code>codesign -f --deep -s "3rd Party Mac Developer Application: " your.app/Contents/Plugins/unitypurchasing.bundle
codesign -f --deep -s "3rd Party Mac Developer Application: " your.app
productbuild --component your.app /Applications --sign "3rd Party Mac Developer Installer: " your.pkg
</code></pre>

<p>要对捆绑包签名，可能首先需要删除 Contents.meta 文件（如果存在）：<code>your.app/Contents/Plugins/unitypurchasing.bundle/Contents.meta</code></p>

<p>为了正确安装应用包，必须先删除未打包的 .app 文件，然后再运行新创建的程序包。</p>

<p>随后，必须从 Applications 文件夹启动应用程序。首次启动应用程序时，系统会提示输入您的 iTunes 帐户详细信息，此时应输入 iTunes Connect 测试用户帐户的登录信息。然后，您便可以在沙盒环境中进行购买测试。</p>

<hr>

<ul>
<li><span class="page-edit">2018–05–30 页面已发布</span></li>
<li><span class="page-history">在 <a href="https://docs.unity3d.com/2017.3/Documentation/Manual/30_search.html?q=newin20173">2017.3</a> 的版本中添加了“购买前先询问”、交易收据和拦截收据 <span class="search-words">NewIn20173</span></span></li>
</ul>
<!-- area:monetization -->
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="UnityIAPCrossStoreInstallationIssues.html"></a></span><div class="tip">Android 应用内购 (IAP) 商店的跨店安装问题</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="UnityIAPUniversalWindows.html"></a></span><div class="tip">通用 Windows 平台</div>
</div>
</div>
</div>
<div class="footer-wrapper">
<div class="footer clear">
<div class="copy">版权所有 © 2020 Unity Technologies. Publication 2019.4</div>
<div class="menu">
<a href="https://learn.unity.com/">教程</a><a href="https://answers.unity3d.com">社区答案</a><a href="https://support.unity3d.com/hc/en-us">知识库</a><a href="https://forum.unity3d.com">论坛</a><a href="https://unity3d.com/asset-store">Asset Store</a>
</div>
</div>
<div></div>
</div>
</div></div></div>
</div>
</body>
</html>
